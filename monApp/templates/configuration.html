{% extends "base.html" %}

{% block title %}Page de configuration{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/config.css') }}">
{% endblock %}


{% block main %}

<div id="loader-overlay">
  <span class="loader"></span>
  <div class="loading-text">Création des groupes en cours...</div>
</div>

<form action="{{ url_for('configuration') }}" method="POST">
    <div class="container mt-5 pt-2">
        
        {% if error %}
            <div class="alert alert-danger" role="alert">
                {{ error }}
            </div>
        {% endif %}

        <section class="config-section">
            <section class="config-base">
                <div class="div-base">
                    <h4>Nombre de groupe</h4>
                    <div>
                        
                        <input type="number" class="level-input" name="nb-grp" min="1"  value="{{ request.form.get('nb-grp', nb_grp ) }}" required>
                    </div>
                    <div class="submit-container" style="text-align: center; margin: 20px 0;">
                        <button type="submit" name="btn" value="btn-valide" class="btn btn-primary">Valider</button>
                    </div>
                </div>
                <h2>Configuration de base</h2>
                <section class="section-importance">
                    <h4>Répartion d'importance </h4>
                    {% for crit_propre in criteres %}
                        {% set nom = "importance_" + crit_propre %}
                        {% set titre_crit = crit_propre.replace('_', ' ').capitalize() %}
                        {% set valeur_defaut = 100 // (criteres|length) %}
                        <div class="{{ crit_propre }}">
                            <h4>{{ titre_crit }}</h4>
                            <input type="range" name="{{ nom }}" min="0" max="100" step="1" class="slider" value="{{ valeur_defaut }}">
                            <div>
                                <input type="number" name="{{ nom }}" class="slider-value" min="0" max="100" step="1" value="{{ valeur_defaut }}">
                            </div>
                        </div>
                    {% endfor %}
                </section>
                
                <script>
                    const sliders = [...document.querySelectorAll(".slider")];
                    const values = [...document.querySelectorAll(".slider-value")];
                    const totalDisplay = document.getElementById("total");
                    const TOTAL_MAX = 100;

                    const previousValues = sliders.map(s => Number(s.value));

                    function clamp(v) {
                        return Math.max(0, Math.min(100, v));
                    }

                    function updateTotal() {
                        const total = sliders.reduce((s, el) => s + Number(el.value), 0);
                        
                        if (totalDisplay) {
                            totalDisplay.textContent = total;
                            totalDisplay.style.color = (total === TOTAL_MAX) ? 'green' : 'red';
                        }
                        return total;
                    }

                    function normalize(changedIndex) {
                        let currentTotal = sliders.reduce((s, el) => s + Number(el.value), 0);
                        if (currentTotal === TOTAL_MAX) {
                            updateTotal();
                            return;
                        }

                        const slider = sliders[changedIndex];
                        const inputValue = values[changedIndex];
                        
                        let newValue = Number(slider.value);
                        const difference = currentTotal - TOTAL_MAX; 

                        if (difference > 0) {
                            newValue = clamp(newValue - difference); 
                            slider.value = newValue;
                            inputValue.value = newValue;
                        } 

                        sliders.forEach((s, i) => values[i].value = s.value);
                        updateTotal();

                        previousValues[changedIndex] = newValue;
                    }


                    sliders.forEach((slider, i) => {
                        slider.addEventListener("input", () => {
                            slider.value = clamp(Number(slider.value));
                            values[i].value = slider.value;
                            normalize(i);
                        });
                    });

                    values.forEach((input, i) => {
                        input.addEventListener("input", () => {
                            let v = clamp(Number(input.value || 0));
                            sliders[i].value = v;
                            input.value = v;
                            normalize(i);
                        });
                    });

                    updateTotal();
                    
                    if (totalDisplay === null) {
                        console.error("L'élément avec l'ID 'total' est manquant. Veuillez l'ajouter au HTML.");
                    }
                </script>
            </section>
            <section class="config-groupe">
                {% if valide %}
                    {% for grp in liste_grp%}
                        <div>
                            <h4>Groupe {{ grp }}</h4>
                        </div>
                    {% endfor %}
                {% endif %}
            </section>
        </section>
        <div class="submit-container" style="text-align: center; margin: 20px 0;">
            <button type="submit" onclick="submitWithLoader()" name="btn" value="btn-repartition"  class="btn btn-primary btn-lg" 
                {% if valide != True %} 
                    disabled
                    style="background-color: gray; border: 2px solid black ;"
                {% endif %}>
                Lancer la répartition
                
            </button>
        </div>

    </div>
</form> 

<script src="../static/script/repartition.js"></script>

{% endblock main %}