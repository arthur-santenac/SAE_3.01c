{% extends "base.html" %}

{% block title %}Page de configuration{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/config.css') }}">
{% endblock %}


{% block main %}

<div id="loader-overlay">
  <span class="loader"></span>
  <div class="loading-text">Création des groupes en cours...</div>
</div>

<form action="{{ url_for('configuration') }}" method="POST">
    <div class="container mt-5 pt-2">
        
        {% if error %}
            <div class="alert alert-danger" role="alert">
                {{ error }}
            </div>
        {% endif %}

        <section class="config-section">
            <section class="config-base">
                <div class="div-base">
                    <h4>Nombre de groupe</h4>
                    <div>
                        
                        <input type="number" class="level-input" name="nb-grp" min="1"  value="{{ request.form.get('nb-grp', nb_grp ) }}" required>
                    </div>
                    <div class="submit-container" style="text-align: center; margin: 20px 0;">
                        <button type="submit" name="btn" value="btn-valide" class="btn btn-primary">Valider</button>
                    </div>
                </div>
                {% if valide %}
                    <h2>Configuration de base</h2>
                    <section class="section-importance">
                        <h4>Répartion d'importance </h4>
                        {% for crit_propre in criteres %}
                            {% set nom = "importance_" + crit_propre %}
                            {% set titre_crit = crit_propre.replace('_', ' ').capitalize() %}
                            {% set valeur_defaut = 100 // (criteres|length) %}
                            <div class="{{ crit_propre }}">
                                <h4>{{ titre_crit }}</h4>
                                <input type="range" name="{{ nom }}" min="0" max="100" step="1" class="slider" value="{{ valeur_defaut }}">
                                <div>
                                    <input type="number" name="{{ nom }}" class="slider-value" min="0" max="100" step="1" value="{{ valeur_defaut }}">
                                </div>
                            </div>
                        {% endfor %}
                    </section>
                {% endif %}
                <script>
                    document.addEventListener("DOMContentLoaded", () => {
                        
                        const groups = [];
                        const container = document.querySelector(".section-importance");
                        
                        
                        if(container) {
                            const divs = container.querySelectorAll("div[class^='importance_']"); 
                            const sliders = document.querySelectorAll(".slider");
                            const values = document.querySelectorAll(".slider-value");
                            
                            sliders.forEach((slider, index) => {
                                groups.push({
                                    slider: slider,
                                    number: values[index],
                                    index: index
                                });
                            });
                        }

                        const TOTAL_TARGET = 100;

                        function updateSliders(activeIndex, newVal) {
                            newVal = Math.max(0, Math.min(TOTAL_TARGET, newVal));
                            
                            groups[activeIndex].slider.value = newVal;
                            groups[activeIndex].number.value = newVal;

                            let currentSum = 0;
                            groups.forEach(g => currentSum += parseInt(g.slider.value));
                            
                            let difference = currentSum - TOTAL_TARGET;

                            while (difference !== 0) {
                                
                                if (difference > 0) {
                                    let candidate = null;
                                    let maxVal = -1;
                                    groups.forEach((g, i) => {
                                        if (i !== activeIndex) {
                                            let val = parseInt(g.slider.value);
                                            if (val > 0 && val > maxVal) {
                                                maxVal = val;
                                                candidate = g;
                                            }
                                        }
                                    });
                                    if (candidate) {
                                        let v = parseInt(candidate.slider.value) - 1;
                                        candidate.slider.value = v;
                                        candidate.number.value = v;
                                        difference--; 
                                    } else {
                                        newVal--;
                                        groups[activeIndex].slider.value = newVal;
                                        groups[activeIndex].number.value = newVal;
                                        difference--;
                                    }
                                } 
                                
                                else if (difference < 0) {
                                    let candidate = null;
                                    let minVal = 101;

                                    groups.forEach((g, i) => {
                                        if (i !== activeIndex) {
                                            let val = parseInt(g.slider.value);
                                            if (val < 100 && val < minVal) {
                                                minVal = val;
                                                candidate = g;
                                            }
                                        }
                                    });

                                    if (candidate) {
                                        let v = parseInt(candidate.slider.value) + 1;
                                        candidate.slider.value = v;
                                        candidate.number.value = v;
                                        difference++;
                                    } else {
                                        difference++;
                                    }
                                }
                            }
                        }

                        groups.forEach((group) => {
                            group.slider.addEventListener('input', (e) => {
                                updateSliders(group.index, parseInt(e.target.value));
                            });
                            group.number.addEventListener('input', (e) => {
                                let val = parseInt(e.target.value);
                                if (isNaN(val)) val = 0;
                                updateSliders(group.index, val);
                            });
                            group.slider.addEventListener('change', (e) => {
                                updateSliders(group.index, parseInt(e.target.value));
                            });
                        });
                    });
                </script>
            </section>
            {% if valide %}
                <section class="config-groupe">
                    <h2>Configuration par groupe</h2>
                        {% for grp in liste_grp %}
                            <div class="groupe-container">
                                <div class="entete-grp-crit">
                                    <h4>Groupe {{ grp }}</h4>
                                </div>
                                <div class="liste-crit-active">
                                    {% for crit in criteres_choisis %}
                                        {% if crit.grp == grp %}
                                        <div class="critere-box card m-2 p-2">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <strong>{{ crit.nom }}</strong>
                                            </div>
                                            <div class="valeurs-container">
                                                <small class="text-muted">Valeurs acceptées :</small><br>
                                                {% set toutes_valeurs = session['liste_val_crit'][crit.nom] %}
                                                <div class="d-flex flex-wrap gap-2 mt-1">
                                                    {% for val in toutes_valeurs %}
                                                        <div class="form-check form-check-inline wrapper-checkbox-badge">
                                                            <input class="form-check-input" 
                                                                type="checkbox" 
                                                                name="chk_{{ grp }}_{{ crit.nom }}" 
                                                                value="{{ val }}" 
                                                                id="chk_{{ grp }}_{{ crit.nom }}_{{ val }}"
                                                                {% if val in crit.valeurs %}checked{% endif %}>
                                                            
                                                            <label class="form-check-label badge" 
                                                                for="chk_{{ grp }}_{{ crit.nom }}_{{ val }}">
                                                                {{ val }}
                                                            </label>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                </section>
            {% endif %}
        </section>
        <div class="submit-container" style="text-align: center; margin: 20px 0;">
            <button type="submit" onclick="submitWithLoader()" name="btn" value="btn-repartition"  class="btn btn-primary btn-lg" 
                {% if valide != True %} 
                    disabled
                    style="background-color: gray; border: 2px solid black ;"
                {% endif %}>
                Lancer la répartition
                
            </button>
        </div>

    </div>
</form> 

<script src="../static/script/repartition.js"></script>

{% endblock main %}