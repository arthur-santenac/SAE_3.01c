{% extends "base.html" %}

{% block title %}Page de configuration{% endblock %}

{# Ce bloc place le CSS dans le <head> du base.html #}
{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/config.css') }}">
{% endblock %}


{# Ce bloc remplit le <main> du base.html #}
{% block main %}

<form action="{{ url_for('configuration') }}" method="POST">
    <div class="container mt-5 pt-2">
        
        {% if error %}
            <div class="alert alert-danger" role="alert">
                {{ error }}
            </div>
        {% endif %}

        <section class="config-section">
            <section class="config-base">
                <div class="div-base">
                    <h4>Nombre de groupe</h4>
                    <div>
                        <input type="number" class="level-input" name="nb-grp" min="1" required>
                    </div>
                </div>
                <h2>Configuration de base</h2>
                <section class="section-importance">
                    <h4>Répartion d'importance </h4>
                    {% for crit_propre in criteres %}
                        {% set nom = "importance_" + crit_propre %}
                        {% set titre_crit = crit_propre.replace('_', ' ').capitalize() %}
                        {% set valeur_defaut = 100 // (criteres|length) %}
                        <div class="{{ crit_propre }}">
                            <h4>{{ titre_crit }}</h4>
                            <input type="range" name="{{ nom }}" min="0" max="100" step="1" class="slider" value="{{ valeur_defaut }}">
                            <div>
                                <input type="number" name="{{ nom }}" class="slider-value" min="0" max="100" step="1" value="{{ valeur_defaut }}">
                            </div>
                        </div>
                    {% endfor %}
                </section>
                
                <script>
                    const sliders = [...document.querySelectorAll(".slider")];
                    const values = [...document.querySelectorAll(".slider-value")];
                    const totalDisplay = document.getElementById("total");
                    const TOTAL_MAX = 100;

                    function clamp(v) {
                        return Math.max(0, Math.min(100, v));
                    }

                    function updateTotal() {
                        const total = sliders.reduce((s, el) => s + Number(el.value), 0);
                        if (totalDisplay) totalDisplay.textContent = total;
                    }

                    function normalize(changedIndex) {
                        let total = sliders.reduce((s, el) => s + Number(el.value), 0);
                        if (total === TOTAL_MAX) return;

                        let diff = TOTAL_MAX - total;
                        const others = sliders
                            .map((s, i) => ({ s, i }))
                            .filter(o => o.i !== changedIndex);

                        for (const o of others) {
                            if (diff === 0) break;
                            let delta = diff > 0 ? 1 : -1;
                            let newVal = clamp(Number(o.s.value) + delta);
                            if (newVal !== Number(o.s.value)) {
                                o.s.value = newVal;
                                diff -= delta;
                            }
                        }

                        sliders.forEach((s, i) => values[i].value = s.value);
                        updateTotal();
                    }

                    sliders.forEach((slider, i) => {
                        slider.addEventListener("input", () => {
                            slider.value = clamp(Number(slider.value));
                            values[i].value = slider.value;
                            normalize(i);
                        });
                    });

                    values.forEach((input, i) => {
                        input.addEventListener("input", () => {
                            let v = clamp(Number(input.value || 0));
                            sliders[i].value = v;
                            input.value = v;
                            normalize(i);
                        });
                    });

                    updateTotal();
                </script>
            </section>
            <section class="config-groupe">

            </section>
        </section>

        <div class="submit-container" style="text-align: center; margin: 20px 0;">
            <button type="submit" class="btn btn-primary btn-lg">Lancer la répartition</button>
        </div>

    </div>
</form> {% endblock main %}